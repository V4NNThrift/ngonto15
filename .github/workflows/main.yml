name: Yanzz RDP (Win 2022 ‚Ä¢ MAX BOOST + Naruto)

on:
  workflow_dispatch:

jobs:
  rdp-naruto:
    runs-on: windows-latest
    timeout-minutes: 3600

    env:
      TAILSCALE_VERSION: "1.82.0"

    steps:
      - name: Enable RDP & open firewall
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "Yanzz"
          $pass = ConvertTo-SecureString "Evan123456" -AsPlainText -Force
          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $user -Password $pass -AccountNeverExpires | Out-Null
          } else {
            Set-LocalUser -Name $user -Password $pass
          }
          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user -ErrorAction SilentlyContinue

      - name: Install Tailscale
        shell: pwsh
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-$env:TAILSCALE_VERSION-amd64.msi"
          $file = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait
          Remove-Item $file -Force

      - name: Connect to Tailscale
        shell: pwsh
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TS_KEY) { Write-Error "‚ùå Tailscale key not set"; exit 1 }
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey "$env:TS_KEY" --hostname "gh-runner-$env:GITHUB_RUN_ID"
          Start-Sleep -Seconds 10
          $ip = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1).Trim()
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "üåê Tailscale IP: $ip"

          $tmp = "$env:TEMP\stardesk"; New-Item -ItemType Directory -Path $tmp -Force | Out-Null
          $out = Join-Path $tmp "StarDesk_1.0.1.exe"

          # 1) Pakai input kalau disediakan
          $urlInput = "${{ github.event.inputs.STAR_DESK_URL }}"
          $urls = @()
          if ($urlInput -and $urlInput.Trim().Length -gt 0) { $urls += $urlInput.Trim() }

          # 2) Kandidat URL umum ke file StarDesk_1.0.1.exe
          $filename = "StarDesk_1.0.1.exe"
          $urls += @(
            "https://www.stardesk.net/$filename",
            "https://www.stardesk.net/res/download/$filename",
            "https://stardesk.net/$filename",
            "https://download.stardesk.net/$filename",
            "https://cdn.stardesk.net/$filename"
          )

          $success = $false
          foreach ($u in $urls) {
            try {
              Write-Host "Trying $u"
              Invoke-WebRequest -Uri $u -OutFile $out -UseBasicParsing -TimeoutSec 180 -MaximumRedirection 5
              if ((Test-Path $out) -and ((Get-Item $out).Length -gt 2MB)) { $success = $true; break }
            } catch {
              Write-Host "Failed: $u"
            }
          }
          if (-not $success) {
            Write-Error "Gagal download StarDesk_1.0.1.exe. Jalankan lagi dan isi input STAR_DESK_URL (link langsung dari tombol 'StarDesk for Windows')."
            exit 1
            
      - name: Show Access Info
        shell: pwsh
        run: |
          Write-Host "`n=== RDP ACCESS INFO ==="
          Write-Host "Address : $env:TAILSCALE_IP"
          Write-Host "Username: Yanzz"
          Write-Host "Password: Evan123456"
          Write-Host "=========================`n"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) {
            Write-Host "[$(Get-Date -Format o)] üü¢ RDP running (MAX BOOST)"
            Start-Sleep -Seconds 300
          }
