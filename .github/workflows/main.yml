name: Yanzz RDP (Performance Max)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2022
    timeout-minutes: 3600  # biar tahan lama, cocok buat AFK Roblox

    steps:
      - name: Enable RDP + Firewall
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP enabled and firewall opened."

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "Yanzz"
          $pass = ConvertTo-SecureString "Evan123456" -AsPlainText -Force
          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $user -Password $pass -AccountNeverExpires | Out-Null
          }
          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user -ErrorAction SilentlyContinue
          Write-Host "‚úÖ User $user created & added to RDP/Admin groups."

      - name: Boost Power Plan (High Performance)
        shell: pwsh
        run: |
          powercfg /setactive SCHEME_MIN
          powercfg -change -monitor-timeout-ac 0
          powercfg -change -disk-timeout-ac 0
          powercfg -change -standby-timeout-ac 0
          powercfg -change -hibernate-timeout-ac 0
          Write-Host "‚ö° High performance plan applied (no sleep/hibernate)."

      - name: Optimize Windows Visuals & Services
        shell: pwsh
        run: |
          Write-Host "üîß Disabling heavy Windows features for max FPS..."
          # Disable Windows Search, SysMain (Superfetch), Themes
          $services = @("SysMain","WSearch","DiagTrack","PrintSpooler","Themes")
          foreach ($svc in $services) {
            if (Get-Service -Name $svc -ErrorAction SilentlyContinue) {
              Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
              Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
              Write-Host "‚õî Disabled service: $svc"
            }
          }

          # Disable visual effects
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\PriorityControl" /v Win32PrioritySeparation /t REG_DWORD /d 26 /f
          reg add "HKCU\Control Panel\Desktop" /v MenuShowDelay /t REG_SZ /d 0 /f

          # Disable animations in RDP sessions
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableMenuAnims /t REG_DWORD /d 1 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableFullWindowDrag /t REG_DWORD /d 1 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableWallpaper /t REG_DWORD /d 1 /f

          Write-Host "üéØ Visuals simplified, animations off, theme stopped."

      - name: Network & TCP Optimization
        shell: pwsh
        run: |
          Write-Host "üåê Applying TCP performance tweaks..."
          netsh int tcp set global autotuninglevel=high
          netsh int tcp set global congestionprovider=ctcp
          netsh int tcp set global ecncapability=enabled
          netsh int tcp set global chimney=disabled
          Write-Host "‚úÖ TCP tuned for throughput & low latency."

      - name: System Cleanup
        shell: pwsh
        run: |
          Write-Host "üßπ Cleaning temp files..."
          $tempPaths = @($env:TEMP, "$env:SystemRoot\Temp")
          foreach ($p in $tempPaths) {
            if (Test-Path $p) {
              Get-ChildItem -Path $p -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
            }
          }
          Write-Host "‚úÖ Cleanup done."

      - name: Verify Settings Summary
        shell: pwsh
        run: |
          Write-Host "`n=== SYSTEM STATUS ==="
          powercfg /getactivescheme
          Get-Service -Name SysMain,WSearch,Themes -ErrorAction SilentlyContinue | Format-Table -AutoSize
          netsh int tcp show global
          Write-Host "=====================`n"

      - name: Keep RDP Session Alive
        shell: pwsh
        run: |
          while ($true) {
            Write-Host "[$(Get-Date -Format o)] üü¢ RDP Performance Session Active ‚Äî stop manually to end."
            Start-Sleep -Seconds 300
          }
